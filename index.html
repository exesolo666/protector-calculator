<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор стоимости — Protector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --card-bg: #111;
      --card-alt-bg: #151515;
      --accent: #ff5a00;
      --accent-soft: #ff7a2a;
      --text: #f5f5f5;
      --muted: #aaaaaa;
      --border: #262626;
      --radius-xl: 18px;
      --radius-md: 8px;
      --shadow-soft: 0 12px 30px rgba(0,0,0,0.55);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: #000;
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    /* Весь калькулятор внутри одного контейнера */
    #protector-calculator {
      width: 100%;
      max-width: 900px;
    }

    /* Карточка калькулятора */
    #protector-calculator .calc-card {
      background: #050505;
      border-radius: var(--radius-xl);
      padding: 16px 14px 14px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.04);
    }

    #protector-calculator .calc-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--accent-soft);
    }

    #protector-calculator .calc-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 14px;
    }

    /* Всегда один столбец, форма сверху, смета снизу */
    #protector-calculator .calc-layout {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    #protector-calculator .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px 12px;
    }

    #protector-calculator .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    #protector-calculator .form-label {
      color: var(--muted);
    }

    #protector-calculator select,
    #protector-calculator input[type="number"] {
      width: 100%;
      padding: 8px 9px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    #protector-calculator select:focus,
    #protector-calculator input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,90,0,0.4);
      background: #171717;
    }

    #protector-calculator option {
      background: #000;
    }

    #protector-calculator .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      margin-top: 4px;
      color: var(--muted);
    }

    #protector-calculator .checkbox-row input {
      accent-color: var(--accent);
    }

    #protector-calculator .btn-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #protector-calculator .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      background: linear-gradient(135deg, #ff9e57, #ff5a00);
      color: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #protector-calculator .btn-primary span {
      font-size: 16px;
    }

    #protector-calculator .btn-ghost {
      border-radius: 999px;
      padding: 7px 11px;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      border: 1px dashed rgba(255,255,255,0.22);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    #protector-calculator .btn-ghost span {
      font-size: 14px;
      color: var(--accent-soft);
    }

    /* Смета */
    #protector-calculator .summary-card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 12px 10px 10px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    #protector-calculator .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    #protector-calculator .summary-title {
      font-size: 15px;
      font-weight: 600;
    }

    #protector-calculator .tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--muted);
    }

    #protector-calculator table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    #protector-calculator thead {
      background: var(--card-alt-bg);
    }

    #protector-calculator th,
    #protector-calculator td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    #protector-calculator th {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    #protector-calculator tbody tr:nth-child(odd) {
      background: rgba(255,255,255,0.02);
    }

    #protector-calculator .col-right {
      text-align: right;
      white-space: nowrap;
    }

    #protector-calculator .badge-from {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent-soft);
      border-radius: 999px;
      border: 1px solid rgba(255,90,0,0.4);
      padding: 1px 5px;
      margin-left: 4px;
    }

    #protector-calculator .empty-placeholder {
      padding: 10px 2px 4px;
      font-size: 12px;
      color: var(--muted);
    }

    #protector-calculator .total-row {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    #protector-calculator .total-label {
      font-size: 12px;
      color: var(--muted);
    }

    #protector-calculator .total-value {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent-soft);
      letter-spacing: 0.04em;
    }

    #protector-calculator .footer-text {
      margin-top: 8px;
      font-size: 10px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 4px;
    }

    #protector-calculator .danger {
      color: #ff9e9e;
      font-size: 11px;
      margin-top: 4px;
      display: none;
    }
  </style>
</head>

<body>
<div id="protector-calculator">
  <div class="calc-card">
    <div class="calc-header">Калькулятор стоимости</div>
    <div class="calc-subtitle">Выберите услуги, чтобы посчитать цену работ по прайсу Protector.</div>

    <div class="calc-layout">
      <!-- Форма -->
      <div>
        <div class="form-grid">
          <div class="form-field">
            <label class="form-label" for="groupSelect">Направление услуги</label>
            <select id="groupSelect"></select>
          </div>

          <div class="form-field">
            <label class="form-label" for="serviceSelect">Конкретные услуги</label>
            <!-- множественный выбор -->
            <select id="serviceSelect" multiple size="6"></select>
          </div>

          <div class="form-field" id="diameterField">
            <label class="form-label" for="diameterSelect">Диаметр / тип</label>
            <select id="diameterSelect"></select>
          </div>

          <div class="form-field">
            <label class="form-label" for="quantityInput">Количество</label>
            <input type="number" id="quantityInput" min="1" value="1">
          </div>
        </div>

        <div class="checkbox-row" id="lowProfileRow">
          <input type="checkbox" id="lowProfileCheckbox">
          <label for="lowProfileCheckbox">Профиль шины &lt; 45 (доплата за низкий профиль)</label>
        </div>

        <div class="danger" id="errorMessage"></div>

        <div class="btn-row">
          <button class="btn-primary" id="addBtn">
            <span>＋</span> Добавить
          </button>
          <button class="btn-ghost" id="clearBtn">
            <span>⟳</span> Очистить
          </button>
        </div>
      </div>

      <!-- Смета -->
      <div>
        <div class="summary-card">
          <div class="summary-header">
            <div class="summary-title">Смета работ</div>
            <div class="tag" id="positionsTag">0 позиций</div>
          </div>

          <table>
            <thead>
            <tr>
              <th>Услуга</th>
              <th>Параметр</th>
              <th class="col-right">Кол-во</th>
              <th class="col-right">Цена</th>
              <th class="col-right">Сумма</th>
            </tr>
            </thead>
            <tbody id="itemsBody">
            <tr id="emptyRow">
              <td colspan="5" class="empty-placeholder">
                Добавьте услугу выше, чтобы увидеть расчёт.
              </td>
            </tr>
            </tbody>
          </table>

          <div class="total-row">
            <div class="total-label">Итого по смете:</div>
            <div class="total-value" id="totalValue">0 ₽</div>
          </div>
        </div>

        <div class="footer-text">
          <span>Все цены по официальному прайсу Protector.</span>
          <span>Позиции «от» уточняются после осмотра.</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const root = document.getElementById('protector-calculator');
  if (!root) return;

  const groupSelect = document.getElementById('groupSelect');
  const serviceSelect = document.getElementById('serviceSelect');
  const diameterSelect = document.getElementById('diameterSelect');
  const diameterField = document.getElementById('diameterField');
  const lowProfileRow = document.getElementById('lowProfileRow');
  const lowProfileCheckbox = document.getElementById('lowProfileCheckbox');
  const quantityInput = document.getElementById('quantityInput');
  const itemsBody = document.getElementById('itemsBody');
  const emptyRow = document.getElementById('emptyRow');
  const positionsTag = document.getElementById('positionsTag');
  const totalValue = document.getElementById('totalValue');
  const errorMessage = document.getElementById('errorMessage');

  if (!groupSelect || !serviceSelect || !quantityInput) return;

  const groups = [
    { id: 'paint',         name: 'Покраска и реставрация дисков' },
    { id: 'tyres-light',   name: 'Шиномонтаж — легковые авто' },
    { id: 'tyres-suv',     name: 'Шиномонтаж — внедорожники, кроссоверы, джипы' },
    { id: 'tyre-repair',   name: 'Ремонт покрышек' },
    { id: 'straightening', name: 'Правка литых дисков' },
    { id: 'steel-rolling', name: 'Раскатка штампованных дисков' },
    { id: 'extras',        name: 'Дополнительные услуги' }
  ];

  const services = [
    // ПОКРАСКА / ПЕСКОСТРУЙ / АЛМАЗКА
    {
      id: 'sandblast',
      group: 'paint',
      name: 'Пескоструйная очистка',
      paramType: 'diameter',
      from: false,
      diameters: {
        'R13': 2000, 'R14': 2000, 'R15': 2500, 'R16': 3000,
        'R17': 3300, 'R18': 3500, 'R19': 4000, 'R20': 4500,
        'R21': 5000, 'R22': 5500, 'Мото': 1000
      }
    },
    {
      id: 'paint-std',
      group: 'paint',
      name: 'Покраска — стандартные цвета',
      paramType: 'diameter',
      from: false,
      diameters: {
        'R13': 8000, 'R14': 8000, 'R15': 10500, 'R16': 11500,
        'R17': 13000, 'R18': 14500, 'R19': 15500, 'R20': 17000,
        'R21': 18500, 'R22': 19500, 'Мото': 7000
      }
    },
    {
      id: 'paint-oem',
      group: 'paint',
      name: 'Покраска — оригинальные цвета',
      paramType: 'diameter',
      from: false,
      diameters: {
        'R13': 8500, 'R14': 8500, 'R15': 12000, 'R16': 13500,
        'R17': 15000, 'R18': 17000, 'R19': 18500, 'R20': 20000,
        'R21': 22000, 'R22': 24000, 'Мото': 9000
      }
    },
    {
      id: 'diamond-single',
      group: 'paint',
      name: 'Алмазная проточка — одноширокие диски',
      paramType: 'diameter',
      from: false,
      diameters: {
        'R13': 3000, 'R14': 3000, 'R15': 4000, 'R16': 5000,
        'R17': 5500, 'R18': 6000, 'R19': 7000, 'R20': 8000,
        'R21': 9000, 'R22': 10000
      }
    },
    {
      id: 'diamond-staggered',
      group: 'paint',
      name: 'Алмазная проточка — разноширокие диски',
      paramType: 'diameter',
      from: false,
      diameters: {
        'R13': 3600, 'R14': 3600, 'R15': 4800, 'R16': 6000,
        'R17': 6500, 'R18': 7200, 'R19': 8400, 'R20': 9600,
        'R21': 10800, 'R22': 12000
      }
    },

    // ЛЕГКОВЫЕ ШИНОМОНТАЖ
    {
      id: 'tyres-light-1',
      group: 'tyres-light',
      name: 'Легковые — цена за 1 колесо (полный цикл)',
      paramType: 'diameter',
      from: false,
      diameters: {
        'R13-14': 400,
        'R15': 475,
        'R16': 500,
        'R17': 600,
        'R18': 700,
        'R19': 825,
        'R20-22': 950
      }
    },
    {
      id: 'tyres-light-4',
      group: 'tyres-light',
      name: 'Легковые — цена за 4 колеса',
      paramType: 'diameter',
      from: false,
      diameters: {
        'R13-14': 1600,
        'R15': 1900,
        'R16': 2000,
        'R17': 2400,
        'R18': 2800,
        'R19': 3300,
        'R20-22': 3800
      }
    },
    {
      id: 'tyres-light-low',
      group: 'tyres-light',
      name: 'Доплата за профиль шины < 45',
      paramType: 'diameter',
      from: false,
      diameters: {
        'R17': 150,
        'R18': 150,
        'R19': 150,
        'R20-22': 150
      }
    },

    // ВНЕДОРОЖНИКИ / КРОССОВЕРЫ
    {
      id: 'tyres-suv-1',
      group: 'tyres-suv',
      name: 'SUV/кроссоверы — цена за 1 колесо',
      paramType: 'diameter',
      from: false,
      diameters: {
        'Кроссоверы R14-16': 650,
        'Кроссоверы R17-18': 800,
        'Кроссоверы R19-20': 950,
        'Кроссоверы R21': 1100,
        'Джипы R15-20': 1000,
        'Джипы R21 и выше': 1100,
        'Газель / транзит и т.д.': 650
      }
    },
    {
      id: 'tyres-suv-4',
      group: 'tyres-suv',
      name: 'SUV/кроссоверы — цена за 4 колеса',
      paramType: 'diameter',
      from: false,
      diameters: {
        'Кроссоверы R14-16': 2600,
        'Кроссоверы R17-18': 3200,
        'Кроссоверы R19-20': 3800,
        'Кроссоверы R21': 4400,
        'Джипы R15-20': 4000,
        'Джипы R21 и выше': 4400,
        'Газель / транзит и т.д.': 4100
      }
    },

    // РЕМОНТ ПОКРЫШЕК
    { id: 'repair-harness',  group: 'tyre-repair', name: 'Установка жгута',                 paramType: 'none', from: false, price: 300 },
    { id: 'repair-plug',     group: 'tyre-repair', name: 'Установка заплатки / грибка',     paramType: 'none', from: true,  price: 450 },
    { id: 'repair-cord',     group: 'tyre-repair', name: 'Установка кордовой заплатки',     paramType: 'none', from: true,  price: 600 },
    { id: 'repair-side',     group: 'tyre-repair', name: 'Ремонт боковых порезов',          paramType: 'none', from: true,  price: 800 },
    { id: 'repair-tube',     group: 'tyre-repair', name: 'Ремонт камеры',                   paramType: 'none', from: false, price: 300 },
    { id: 'repair-clean',    group: 'tyre-repair', name: 'Зачистка диска',                  paramType: 'none', from: false, price: 50  },
    { id: 'repair-seal',     group: 'tyre-repair', name: 'Промазать диск герметиком',       paramType: 'none', from: false, price: 100 },
    { id: 'repair-bag',      group: 'tyre-repair', name: 'Пакет',                           paramType: 'none', from: false, price: 25  },
    { id: 'repair-valve-simple', group: 'tyre-repair', name: 'Вентиль простой',             paramType: 'none', from: false, price: 75  },
    { id: 'repair-valve-chrome', group: 'tyre-repair', name: 'Вентиль крем',                paramType: 'none', from: false, price: 75  },

    // ПРАВКА
    {
      id: 'straightening-main',
      group: 'straightening',
      name: 'Правка литых дисков',
      paramType: 'diameter',
      from: true,
      diameters: {
        'R13': 700, 'R14': 800, 'R15': 900, 'R16': 1000,
        'R17': 1200, 'R18': 1500, 'R19': 1700, 'R20': 2000, 'R21': 2500
      }
    },

    // РАСКАТКА ШТАМПОВАННЫХ
    {
      id: 'steel-rolling-main',
      group: 'steel-rolling',
      name: 'Раскатка штампованных дисков',
      paramType: 'diameter',
      from: false,
      diameters: { 'R14': 500, 'R15': 500, 'R16': 500 }
    },

    // ДОП. УСЛУГИ
    { id: 'chips',     group: 'extras', name: 'Ремонт сколов и задиров',     paramType: 'none', from: true,  price: 500 },
    { id: 'argon',     group: 'extras', name: 'Сварочные работы (аргон)',    paramType: 'none', from: false, price: 700 },
    { id: 'complex-tyres', group: 'extras', name: 'Комплексный шиномонтаж',  paramType: 'none', from: true,  price: 1000 },
    { id: 'geometry',  group: 'extras', name: 'Правка геометрии дисков',     paramType: 'none', from: true,  price: 500 },
    { id: 'polish',    group: 'extras', name: 'Полировка дисков',            paramType: 'none', from: true,  price: 1500 },
    { id: 'hanging',   group: 'extras', name: 'Вывешивание автомобиля',      paramType: 'none', from: true,  price: 500 },
    { id: 'sensor',    group: 'extras', name: 'Установка датчика',           paramType: 'none', from: false, price: 150 },
    { id: 'inflation', group: 'extras', name: 'Подкачка',                    paramType: 'none', from: false, price: 100 }
  ];

  function formatPrice(value, isFrom = false) {
    if (value == null || isNaN(value)) return '—';
    const formatted = value.toLocaleString('ru-RU');
    return (isFrom ? 'от ' : '') + formatted + ' ₽';
  }

  function setError(msg) {
    if (!errorMessage) return;
    if (msg) {
      errorMessage.textContent = msg;
      errorMessage.style.display = 'block';
    } else {
      errorMessage.textContent = '';
      errorMessage.style.display = 'none';
    }
  }

  let items = [];

  function updatePositionsTag() {
    positionsTag.textContent = items.length + ' позиций';
  }

  function populateGroups() {
    groupSelect.innerHTML = '';
    groups.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.id;
      opt.textContent = g.name;
      groupSelect.appendChild(opt);
    });
  }

  // Не сбрасываем диаметр при смене услуги, если он есть в новой услуге
  function updateDiameterVisibility() {
    const service = services.find(s => s.id === serviceSelect.value);
    if (!service) return;

    const previous = diameterSelect.value;

    if (service.paramType === 'diameter') {
      diameterField.style.display = 'flex';
      diameterSelect.innerHTML = '';

      const keys = Object.keys(service.diameters);

      keys.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        diameterSelect.appendChild(opt);
      });

      if (previous && service.diameters[previous] !== undefined) {
        diameterSelect.value = previous;
      } else {
        diameterSelect.value = keys[0];
      }
    } else {
      diameterField.style.display = 'none';
      diameterSelect.innerHTML = '';
    }
  }

  function updateLowProfileVisibility() {
    const groupId = groupSelect.value;
    lowProfileRow.style.display = groupId === 'tyres-light' ? 'flex' : 'none';
    if (groupId !== 'tyres-light') lowProfileCheckbox.checked = false;
  }

  // Заполняем услуги, выделяем первую по умолчанию
  function populateServices() {
    const groupId = groupSelect.value;
    const filtered = services.filter(s => s.group === groupId);
    serviceSelect.innerHTML = '';

    filtered.forEach((s, index) => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.name;
      if (index === 0) opt.selected = true;
      serviceSelect.appendChild(opt);
    });

    updateDiameterVisibility();
    updateLowProfileVisibility();
  }

  function renderItems() {
    itemsBody.innerHTML = '';
    if (!items.length) {
      itemsBody.appendChild(emptyRow);
      emptyRow.style.display = '';
      totalValue.textContent = '0 ₽';
      updatePositionsTag();
      return;
    }
    emptyRow.style.display = 'none';
    let total = 0;

    items.forEach(item => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      tdName.textContent = item.name;
      if (item.from) {
        const b = document.createElement('span');
        b.textContent = 'от';
        b.className = 'badge-from';
        tdName.appendChild(b);
      }

      const tdParam = document.createElement('td');
      tdParam.textContent = item.param || '—';

      const tdQty = document.createElement('td');
      tdQty.className = 'col-right';
      tdQty.textContent = item.quantity;

      const tdPrice = document.createElement('td');
      tdPrice.className = 'col-right';
      tdPrice.textContent = formatPrice(item.unitPrice, item.from);

      const tdSum = document.createElement('td');
      tdSum.className = 'col-right';
      tdSum.textContent = formatPrice(item.sum, item.from);

      tr.append(tdName, tdParam, tdQty, tdPrice, tdSum);
      itemsBody.appendChild(tr);

      total += item.sum;
    });

    totalValue.textContent = total.toLocaleString('ru-RU') + ' ₽';
    updatePositionsTag();
  }

  // Добавляем сразу все выбранные услуги
  function addItem() {
    setError(null);
    const groupId = groupSelect.value;

    const selectedServiceIds = Array.from(serviceSelect.selectedOptions || [])
      .map(opt => opt.value);

    if (!selectedServiceIds.length) {
      setError('Выберите хотя бы одну услугу.');
      return;
    }

    const selectedServices = selectedServiceIds
      .map(id => services.find(s => s.id === id))
      .filter(Boolean);

    if (!selectedServices.length) {
      setError('Не удалось найти выбранные услуги.');
      return;
    }

    const quantity = Number(quantityInput.value || '0');
    if (!Number.isFinite(quantity) || quantity <= 0) {
      setError('Количество должно быть больше 0.');
      return;
    }

    const toAdd = [];
    let diameterForLowProfile = null;

    for (const service of selectedServices) {
      let paramValue = null;
      let unitPrice = null;

      if (service.paramType === 'diameter') {
        paramValue = diameterSelect.value;
        unitPrice = service.diameters[paramValue];
        if (unitPrice == null) {
          setError('Для выбранного диаметра цена не указана для услуги: ' + service.name);
          return;
        }
        diameterForLowProfile = paramValue;
      } else {
        unitPrice = service.price;
      }

      if (!Number.isFinite(unitPrice)) {
        setError('Не удалось определить цену для услуги: ' + service.name);
        return;
      }

      toAdd.push({
        name: service.name,
        param: paramValue,
        quantity,
        unitPrice,
        sum: unitPrice * quantity,
        from: !!service.from
      });
    }

    if (groupId === 'tyres-light' && lowProfileCheckbox.checked && diameterForLowProfile) {
      const lowService = services.find(s => s.id === 'tyres-light-low');
      if (lowService) {
        const lowPrice = lowService.diameters[diameterForLowProfile] || 0;
        if (lowPrice > 0) {
          toAdd.push({
            name: lowService.name,
            param: diameterForLowProfile,
            quantity,
            unitPrice: lowPrice,
            sum: lowPrice * quantity,
            from: false
          });
        }
      }
    }

    items = items.concat(toAdd);
    renderItems();
  }

  function clearItems() {
    items = [];
    renderItems();
  }

  document.getElementById('addBtn').addEventListener('click', addItem);
  document.getElementById('clearBtn').addEventListener('click', clearItems);
  groupSelect.addEventListener('change', () => { populateServices(); setError(null); });
  serviceSelect.addEventListener('change', () => { updateDiameterVisibility(); setError(null); });

  // Старт
  populateGroups();
  populateServices();
  renderItems();
});
</script>
</body>
</html>
